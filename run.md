# Running the application

## Run the test app

Start a Docker container on a GPU enabled environment
```
$ docker run --gpus all --rm -it informaticsmatters/deep-app-ubuntu-1604:latest bash
```

The in the container un the app using:
```
# ./call_main.sh
```

Results are found in `/root/train/fragalysis_test_files/test_1/caffe_output/predictions.txt`.

## How it works

The `call_main.sh` shell script calls:

```
python3 main.py -b . -n test_1 -m resources/dense.prototxt -w resources/weights.caffemodel -f resources/test_folds.txt -s 16 --predict_only
```

This generates the `test_1` directory where the action happens and the use of the `--predict_only` flag results in execution of:
```
python3 scripts/predict.py -m resources/dense.prototxt -w /root/train/fragalysis_test_files/test_1/caffe_output/weights.caffemodel\
  -i /root/train/fragalysis_test_files/test_1/test_set_1.types >> /root/train/fragalysis_test_files/test_1/caffe_output/predictions_1.txt
``` 

The real work is done by the `predict.py` script. `main.py` just sets things up.

The params to the `predict.py` script are:

| arg | value | purpose |
|-----|-------|---------|
| -m  | resources/dense.prototxt | Protocol definition file? Text format. Constant between runs |
| -w  | /root/train/fragalysis_test_files/test_1/caffe_output/weights.caffemodel | Model weights. Generated by `main.py` prior to execution of `predict.py`. Seems to be copied from `./resources/weights.caffemodel` |
| -i  | /root/train/fragalysis_test_files/test_1/test_set_1.types | The inputs to predict. One per line in ginatypes format. |
|     | stdout | Redirected to /root/train/fragalysis_test_files/test_1/caffe_output/predictions_1.txt |

The format of the `-i` option seems to be `<0 or 1> <receptor_filename> <ligand_filename>` (space separated) with each line
being a receptor/ligand combination and the first token, 0 or 1 presumably indication positive or negative. Presumably this 
first field is ony used during training?

Results end up in `test_1/caffe_output/predictions_1.txt` and have the format `<score> | <0 or 1> <receptor_filename> <ligand_filename>`.
Presumably the part after the pipe symbol is carried over directly from the entries in the `-i` option.

## Simplified execution

Predictions can be run directly with the `predict.py` script by:

1. Create a working dir e.g. `/root/train/fragalysis_test_files/work_0`.
2. Creating inputs in gninatypes format: `gninatyper <input filename> <output filename>`. Put them somewhere that are
accessible.
3. Create a `work_0/test_set.types` file that lists the inputs. Alternatively copy the example
`resources/test_types.types` file which uses data from `chembl_test_data` 
e.g. `cp resources/test_types.types work_0/test_set.types`.
4. Create a `work_0/caffe_output` directory. e.g `mkdir work_0/caffe_output`.
5. Run using 
```
python3 scripts/predict.py -m resources/dense.prototxt -w resources/weights.caffemodel -i work_0/test_set.types >> work_0/caffe_output/predictions.txt
```